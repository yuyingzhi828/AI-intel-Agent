name: Intel Agent Patrol

on:
  schedule:
    - cron: '0 */6 * * *' # 每6小时运行一次 (UTC时间)
  workflow_dispatch:      # 允许你手动点击按钮运行

permissions:
  contents: write         # 赋予写权限，以便保存历史记录和文件

jobs:
  patrol:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        
      - name: Run Agent
        env:
          GIST_URL: ${{ secrets.GIST_URL }}
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python main.py
        
      # --- 新增步骤：把刚才 Python 脚本生成的 .md 文件打包备份 ---
      - name: Upload Intelligence Reports
        uses: actions/upload-artifact@v4
        with:
          name: Daily-Intelligence-Reports # 下载时的压缩包名称
          path: "*.md"                     # 抓取当前目录下所有的 .md 文件
          if-no-files-found: ignore        # 如果这次巡逻没有新情报(没生成md文件)，则忽略不报错
        
      - name: Commit and Push History
        run: |
          git config --global user.name 'IntelBot'
          git config --global user.email 'bot@noreply.github.com'
          
          git add history.json
          
          # 检查是否有文件更新，如果有则提交
          if ! git diff --staged --quiet; then
            git commit -m "Auto-update history"
            
            # 【终极防冲突魔法】拉取远程代码，如果别人在你运行期间修改了历史记录，强制使用本地最新的记录覆盖
            git pull origin main --no-rebase -X ours
            
            git push
          else
            echo "没有新的情报，history.json 无需更新。"
          fi
